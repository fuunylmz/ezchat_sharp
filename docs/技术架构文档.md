# EzChat Sharp - 技术架构文档

## 项目概述

EzChat Sharp 是一个基于 C# .NET 9.0 的简单聊天系统，采用客户端-服务器架构，实现多用户实时聊天功能。项目完全基于命令行界面，适合作为网络编程和 C# 学习的练手项目。

## 技术栈

### 核心技术
- **开发语言**: C# 12.0
- **运行时**: .NET 9.0
- **架构模式**: 客户端-服务器架构
- **通信协议**: TCP Socket
- **序列化**: JSON (System.Text.Json)
- **并发处理**: async/await + Task

### 开发工具
- **IDE**: Visual Studio 2022 / VS Code
- **版本控制**: Git
- **包管理**: NuGet

## 系统架构

### 整体架构图
```
┌─────────────────┐    TCP/IP    ┌─────────────────┐
│   Chat Client   │◄────────────►│   Chat Server   │
│                 │              │                 │
│ - 用户界面      │              │ - 连接管理      │
│ - 消息发送      │              │ - 消息转发      │
│ - 消息接收      │              │ - 用户管理      │
└─────────────────┘              └─────────────────┘
                                          │
                                          ▼
                                 ┌─────────────────┐
                                 │   内存存储      │
                                 │ - 在线用户列表  │
                                 │ - 聊天室信息    │
                                 └─────────────────┘
```

### 服务器端架构

#### 核心组件
1. **服务器主程序 (ChatServer)**
   - 监听客户端连接
   - 管理客户端会话
   - 协调消息转发

2. **客户端会话管理器 (ClientSessionManager)**
   - 维护活跃连接列表
   - 处理客户端连接/断开
   - 管理用户状态

3. **消息处理器 (MessageHandler)**
   - 解析客户端消息
   - 执行相应的业务逻辑
   - 构造响应消息

4. **聊天室管理器 (ChatRoomManager)**
   - 管理聊天室创建/销毁
   - 处理用户加入/离开
   - 广播消息到房间成员

#### 数据模型
```csharp
// 用户信息
public class User
{
    public string UserId { get; set; }
    public string Username { get; set; }
    public DateTime ConnectedAt { get; set; }
    public string CurrentRoom { get; set; }
}

// 消息模型
public class ChatMessage
{
    public string MessageId { get; set; }
    public string SenderId { get; set; }
    public string SenderName { get; set; }
    public string Content { get; set; }
    public DateTime Timestamp { get; set; }
    public MessageType Type { get; set; }
    public string TargetRoom { get; set; }
}

// 聊天室信息
public class ChatRoom
{
    public string RoomId { get; set; }
    public string RoomName { get; set; }
    public List<string> Members { get; set; }
    public DateTime CreatedAt { get; set; }
    public int MaxMembers { get; set; }
}
```

### 客户端架构

#### 核心组件
1. **客户端主程序 (ChatClient)**
   - 连接服务器
   - 用户界面控制
   - 消息收发协调

2. **网络通信管理器 (NetworkManager)**
   - TCP 连接管理
   - 消息序列化/反序列化
   - 网络异常处理

3. **用户界面管理器 (UIManager)**
   - 命令行界面渲染
   - 用户输入处理
   - 消息显示格式化

4. **消息队列 (MessageQueue)**
   - 接收消息缓存
   - 发送消息队列
   - 消息优先级处理

## 通信协议设计

### 消息格式
所有消息采用 JSON 格式，基本结构如下：
```json
{
  "type": "message_type",
  "timestamp": "2024-01-01T12:00:00Z",
  "data": {
    // 具体消息内容
  }
}
```

### 消息类型定义

#### 客户端到服务器
- `LOGIN`: 用户登录
- `LOGOUT`: 用户登出
- `JOIN_ROOM`: 加入聊天室
- `LEAVE_ROOM`: 离开聊天室
- `SEND_MESSAGE`: 发送消息
- `LIST_ROOMS`: 获取聊天室列表
- `LIST_USERS`: 获取在线用户列表
- `CREATE_ROOM`: 创建聊天室

#### 服务器到客户端
- `LOGIN_SUCCESS`: 登录成功
- `LOGIN_FAILED`: 登录失败
- `MESSAGE_RECEIVED`: 接收到消息
- `USER_JOINED`: 用户加入通知
- `USER_LEFT`: 用户离开通知
- `ROOM_LIST`: 聊天室列表
- `USER_LIST`: 用户列表
- `ERROR`: 错误信息
- `SERVER_SHUTDOWN`: 服务器关闭通知

### 连接流程
```
Client                    Server
  │                         │
  │──── TCP Connect ────────►│
  │                         │
  │──── LOGIN Request ──────►│
  │                         │
  │◄─── LOGIN_SUCCESS ──────│
  │                         │
  │──── JOIN_ROOM ──────────►│
  │                         │
  │◄─── USER_JOINED ────────│
  │                         │
  │──── SEND_MESSAGE ───────►│
  │                         │
  │◄─── MESSAGE_RECEIVED ───│
  │                         │
```

## 并发处理策略

### 服务器端并发
- 使用 `async/await` 模式处理异步 I/O
- 每个客户端连接独立的 Task 处理
- 使用 `ConcurrentDictionary` 管理共享状态
- 消息广播使用 `Task.WhenAll` 并行发送

### 线程安全考虑
- 用户列表和聊天室列表使用线程安全集合
- 消息处理使用无锁编程模式
- 关键操作使用 `SemaphoreSlim` 控制并发

## 错误处理策略

### 网络异常
- 连接断开自动重连机制
- 超时检测和处理
- 网络状态监控

### 业务异常
- 用户名重复检查
- 聊天室容量限制
- 消息长度限制
- 非法字符过滤

### 日志记录
- 使用 `Microsoft.Extensions.Logging`
- 分级日志记录（Debug, Info, Warning, Error）
- 结构化日志格式

## 性能优化考虑

### 内存管理
- 使用对象池减少 GC 压力
- 及时释放断开连接的资源
- 消息缓存大小限制

### 网络优化
- 消息批量发送
- 压缩大消息内容
- 心跳包机制

### 扩展性设计
- 插件化消息处理器
- 可配置的服务器参数
- 模块化组件设计

## 安全考虑

### 基础安全
- 输入验证和清理
- 消息长度限制
- 连接频率限制
- 简单的用户认证

### 未来扩展
- SSL/TLS 加密通信
- 用户权限管理
- 消息审核机制
- 防刷屏机制

## 部署架构

### 开发环境
- 本地开发：服务器和客户端在同一机器
- 测试环境：局域网内多客户端测试

### 生产环境考虑
- 服务器独立部署
- 配置文件外部化
- 日志文件管理
- 监控和告警

---

*本文档将随着项目开发进度持续更新*