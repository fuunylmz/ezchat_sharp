# EzChat Sharp - 数据设计文档

## 概述

EzChat Sharp 采用内存存储方案，所有数据在服务器运行期间保存在内存中。本文档定义了数据模型、存储结构和未来数据库扩展的设计方案。

## 数据存储策略

### 当前方案：内存存储
- **优点**: 简单快速，无需外部依赖
- **缺点**: 数据不持久化，服务器重启后丢失
- **适用场景**: 开发学习、小规模测试

### 未来扩展：数据库存储
- **SQLite**: 轻量级，适合小规模部署
- **PostgreSQL**: 功能完整，适合生产环境
- **Redis**: 高性能缓存，适合会话管理

## 核心数据模型

### 1. 用户模型 (User)

```csharp
public class User
{
    /// <summary>
    /// 用户唯一标识符
    /// </summary>
    public string UserId { get; set; } = Guid.NewGuid().ToString();
    
    /// <summary>
    /// 用户名，3-20字符，唯一
    /// </summary>
    public string Username { get; set; } = string.Empty;
    
    /// <summary>
    /// 用户显示名称
    /// </summary>
    public string DisplayName { get; set; } = string.Empty;
    
    /// <summary>
    /// 连接时间
    /// </summary>
    public DateTime ConnectedAt { get; set; } = DateTime.UtcNow;
    
    /// <summary>
    /// 最后活动时间
    /// </summary>
    public DateTime LastActivity { get; set; } = DateTime.UtcNow;
    
    /// <summary>
    /// 当前所在聊天室
    /// </summary>
    public string CurrentRoom { get; set; } = "general";
    
    /// <summary>
    /// 用户状态
    /// </summary>
    public UserStatus Status { get; set; } = UserStatus.Online;
    
    /// <summary>
    /// 是否在线
    /// </summary>
    public bool IsOnline { get; set; } = true;
    
    /// <summary>
    /// 客户端版本
    /// </summary>
    public string ClientVersion { get; set; } = string.Empty;
    
    /// <summary>
    /// IP地址
    /// </summary>
    public string IpAddress { get; set; } = string.Empty;
    
    /// <summary>
    /// 用户权限级别
    /// </summary>
    public UserRole Role { get; set; } = UserRole.User;
}

/// <summary>
/// 用户状态枚举
/// </summary>
public enum UserStatus
{
    Online,     // 在线
    Away,       // 离开
    Busy,       // 忙碌
    Invisible   // 隐身
}

/// <summary>
/// 用户角色枚举
/// </summary>
public enum UserRole
{
    User,       // 普通用户
    Moderator,  // 版主
    Admin       // 管理员
}
```

### 2. 聊天室模型 (ChatRoom)

```csharp
public class ChatRoom
{
    /// <summary>
    /// 聊天室唯一标识符
    /// </summary>
    public string RoomId { get; set; } = Guid.NewGuid().ToString();
    
    /// <summary>
    /// 聊天室名称，3-30字符，唯一
    /// </summary>
    public string RoomName { get; set; } = string.Empty;
    
    /// <summary>
    /// 聊天室主题/描述
    /// </summary>
    public string Topic { get; set; } = string.Empty;
    
    /// <summary>
    /// 创建时间
    /// </summary>
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    
    /// <summary>
    /// 创建者用户ID
    /// </summary>
    public string CreatorId { get; set; } = string.Empty;
    
    /// <summary>
    /// 当前成员列表
    /// </summary>
    public HashSet<string> Members { get; set; } = new();
    
    /// <summary>
    /// 最大成员数量
    /// </summary>
    public int MaxMembers { get; set; } = 50;
    
    /// <summary>
    /// 是否为私有聊天室
    /// </summary>
    public bool IsPrivate { get; set; } = false;
    
    /// <summary>
    /// 聊天室密码（可选）
    /// </summary>
    public string? Password { get; set; }
    
    /// <summary>
    /// 是否为系统默认聊天室
    /// </summary>
    public bool IsDefault { get; set; } = false;
    
    /// <summary>
    /// 聊天室状态
    /// </summary>
    public RoomStatus Status { get; set; } = RoomStatus.Active;
    
    /// <summary>
    /// 最后活动时间
    /// </summary>
    public DateTime LastActivity { get; set; } = DateTime.UtcNow;
}

/// <summary>
/// 聊天室状态枚举
/// </summary>
public enum RoomStatus
{
    Active,     // 活跃
    Inactive,   // 非活跃
    Archived,   // 已归档
    Deleted     // 已删除
}
```

### 3. 消息模型 (ChatMessage)

```csharp
public class ChatMessage
{
    /// <summary>
    /// 消息唯一标识符
    /// </summary>
    public string MessageId { get; set; } = Guid.NewGuid().ToString();
    
    /// <summary>
    /// 发送者用户ID
    /// </summary>
    public string SenderId { get; set; } = string.Empty;
    
    /// <summary>
    /// 发送者用户名
    /// </summary>
    public string SenderName { get; set; } = string.Empty;
    
    /// <summary>
    /// 消息内容
    /// </summary>
    public string Content { get; set; } = string.Empty;
    
    /// <summary>
    /// 发送时间
    /// </summary>
    public DateTime Timestamp { get; set; } = DateTime.UtcNow;
    
    /// <summary>
    /// 消息类型
    /// </summary>
    public MessageType Type { get; set; } = MessageType.Text;
    
    /// <summary>
    /// 目标聊天室ID
    /// </summary>
    public string TargetRoomId { get; set; } = string.Empty;
    
    /// <summary>
    /// 目标用户ID（私聊消息）
    /// </summary>
    public string? TargetUserId { get; set; }
    
    /// <summary>
    /// 回复的消息ID（可选）
    /// </summary>
    public string? ReplyToMessageId { get; set; }
    
    /// <summary>
    /// 消息状态
    /// </summary>
    public MessageStatus Status { get; set; } = MessageStatus.Sent;
    
    /// <summary>
    /// 消息优先级
    /// </summary>
    public MessagePriority Priority { get; set; } = MessagePriority.Normal;
}

/// <summary>
/// 消息类型枚举
/// </summary>
public enum MessageType
{
    Text,           // 文本消息
    Emoji,          // 表情消息
    System,         // 系统消息
    Command,        // 命令消息
    Private,        // 私聊消息
    Announcement    // 公告消息
}

/// <summary>
/// 消息状态枚举
/// </summary>
public enum MessageStatus
{
    Sent,       // 已发送
    Delivered,  // 已送达
    Read,       // 已读
    Failed,     // 发送失败
    Deleted     // 已删除
}

/// <summary>
/// 消息优先级枚举
/// </summary>
public enum MessagePriority
{
    Low,        // 低优先级
    Normal,     // 普通优先级
    High,       // 高优先级
    Critical    // 紧急优先级
}
```

### 4. 客户端会话模型 (ClientSession)

```csharp
public class ClientSession
{
    /// <summary>
    /// 会话唯一标识符
    /// </summary>
    public string SessionId { get; set; } = Guid.NewGuid().ToString();
    
    /// <summary>
    /// 关联的用户ID
    /// </summary>
    public string UserId { get; set; } = string.Empty;
    
    /// <summary>
    /// TCP客户端连接
    /// </summary>
    public TcpClient TcpClient { get; set; }
    
    /// <summary>
    /// 网络流
    /// </summary>
    public NetworkStream NetworkStream { get; set; }
    
    /// <summary>
    /// 连接建立时间
    /// </summary>
    public DateTime ConnectedAt { get; set; } = DateTime.UtcNow;
    
    /// <summary>
    /// 最后心跳时间
    /// </summary>
    public DateTime LastHeartbeat { get; set; } = DateTime.UtcNow;
    
    /// <summary>
    /// 是否已认证
    /// </summary>
    public bool IsAuthenticated { get; set; } = false;
    
    /// <summary>
    /// 客户端IP地址
    /// </summary>
    public string IpAddress { get; set; } = string.Empty;
    
    /// <summary>
    /// 客户端端口
    /// </summary>
    public int Port { get; set; }
    
    /// <summary>
    /// 发送消息计数器
    /// </summary>
    public int MessagesSent { get; set; } = 0;
    
    /// <summary>
    /// 接收消息计数器
    /// </summary>
    public int MessagesReceived { get; set; } = 0;
    
    /// <summary>
    /// 取消令牌源
    /// </summary>
    public CancellationTokenSource CancellationTokenSource { get; set; } = new();
}
```

## 内存存储结构

### 1. 数据存储管理器

```csharp
public class InMemoryDataStore
{
    // 用户存储：UserId -> User
    private readonly ConcurrentDictionary<string, User> _users = new();
    
    // 用户名索引：Username -> UserId
    private readonly ConcurrentDictionary<string, string> _usernameIndex = new();
    
    // 聊天室存储：RoomId -> ChatRoom
    private readonly ConcurrentDictionary<string, ChatRoom> _rooms = new();
    
    // 聊天室名称索引：RoomName -> RoomId
    private readonly ConcurrentDictionary<string, string> _roomNameIndex = new();
    
    // 消息存储：MessageId -> ChatMessage
    private readonly ConcurrentDictionary<string, ChatMessage> _messages = new();
    
    // 房间消息索引：RoomId -> List<MessageId>
    private readonly ConcurrentDictionary<string, ConcurrentQueue<string>> _roomMessages = new();
    
    // 私聊消息索引：UserId -> List<MessageId>
    private readonly ConcurrentDictionary<string, ConcurrentQueue<string>> _privateMessages = new();
    
    // 客户端会话存储：SessionId -> ClientSession
    private readonly ConcurrentDictionary<string, ClientSession> _sessions = new();
    
    // 用户会话索引：UserId -> SessionId
    private readonly ConcurrentDictionary<string, string> _userSessionIndex = new();
    
    // 在线用户集合
    private readonly ConcurrentHashSet<string> _onlineUsers = new();
    
    // 房间成员索引：RoomId -> HashSet<UserId>
    private readonly ConcurrentDictionary<string, ConcurrentHashSet<string>> _roomMembers = new();
}
```

### 2. 数据访问接口

```csharp
public interface IDataStore
{
    // 用户管理
    Task<User?> GetUserAsync(string userId);
    Task<User?> GetUserByUsernameAsync(string username);
    Task<bool> AddUserAsync(User user);
    Task<bool> UpdateUserAsync(User user);
    Task<bool> RemoveUserAsync(string userId);
    Task<IEnumerable<User>> GetOnlineUsersAsync();
    Task<IEnumerable<User>> GetRoomUsersAsync(string roomId);
    
    // 聊天室管理
    Task<ChatRoom?> GetRoomAsync(string roomId);
    Task<ChatRoom?> GetRoomByNameAsync(string roomName);
    Task<bool> AddRoomAsync(ChatRoom room);
    Task<bool> UpdateRoomAsync(ChatRoom room);
    Task<bool> RemoveRoomAsync(string roomId);
    Task<IEnumerable<ChatRoom>> GetAllRoomsAsync();
    Task<IEnumerable<ChatRoom>> GetPublicRoomsAsync();
    
    // 消息管理
    Task<bool> AddMessageAsync(ChatMessage message);
    Task<ChatMessage?> GetMessageAsync(string messageId);
    Task<IEnumerable<ChatMessage>> GetRoomMessagesAsync(string roomId, int limit = 50);
    Task<IEnumerable<ChatMessage>> GetPrivateMessagesAsync(string userId1, string userId2, int limit = 50);
    Task<bool> DeleteMessageAsync(string messageId);
    
    // 会话管理
    Task<bool> AddSessionAsync(ClientSession session);
    Task<ClientSession?> GetSessionAsync(string sessionId);
    Task<ClientSession?> GetUserSessionAsync(string userId);
    Task<bool> RemoveSessionAsync(string sessionId);
    Task<IEnumerable<ClientSession>> GetAllSessionsAsync();
    
    // 房间成员管理
    Task<bool> AddUserToRoomAsync(string userId, string roomId);
    Task<bool> RemoveUserFromRoomAsync(string userId, string roomId);
    Task<bool> IsUserInRoomAsync(string userId, string roomId);
    Task<IEnumerable<string>> GetUserRoomsAsync(string userId);
}
```

### 3. 缓存策略

```csharp
public class CacheConfiguration
{
    /// <summary>
    /// 消息缓存大小（每个房间）
    /// </summary>
    public int MessageCacheSize { get; set; } = 1000;
    
    /// <summary>
    /// 私聊消息缓存大小（每个用户对）
    /// </summary>
    public int PrivateMessageCacheSize { get; set; } = 500;
    
    /// <summary>
    /// 用户活动缓存时间（分钟）
    /// </summary>
    public int UserActivityCacheMinutes { get; set; } = 30;
    
    /// <summary>
    /// 房间统计缓存时间（分钟）
    /// </summary>
    public int RoomStatsCacheMinutes { get; set; } = 5;
    
    /// <summary>
    /// 自动清理间隔（分钟）
    /// </summary>
    public int CleanupIntervalMinutes { get; set; } = 10;
}
```

## 数据持久化设计（未来扩展）

### 1. SQLite 数据库设计

```sql
-- 用户表
CREATE TABLE Users (
    UserId TEXT PRIMARY KEY,
    Username TEXT UNIQUE NOT NULL,
    DisplayName TEXT,
    CreatedAt DATETIME DEFAULT CURRENT_TIMESTAMP,
    LastLoginAt DATETIME,
    Status INTEGER DEFAULT 0,
    Role INTEGER DEFAULT 0,
    IsActive BOOLEAN DEFAULT 1
);

-- 聊天室表
CREATE TABLE ChatRooms (
    RoomId TEXT PRIMARY KEY,
    RoomName TEXT UNIQUE NOT NULL,
    Topic TEXT,
    CreatedAt DATETIME DEFAULT CURRENT_TIMESTAMP,
    CreatorId TEXT,
    MaxMembers INTEGER DEFAULT 50,
    IsPrivate BOOLEAN DEFAULT 0,
    Password TEXT,
    IsDefault BOOLEAN DEFAULT 0,
    Status INTEGER DEFAULT 0,
    FOREIGN KEY (CreatorId) REFERENCES Users(UserId)
);

-- 消息表
CREATE TABLE Messages (
    MessageId TEXT PRIMARY KEY,
    SenderId TEXT NOT NULL,
    Content TEXT NOT NULL,
    Timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    Type INTEGER DEFAULT 0,
    TargetRoomId TEXT,
    TargetUserId TEXT,
    ReplyToMessageId TEXT,
    Status INTEGER DEFAULT 0,
    Priority INTEGER DEFAULT 1,
    FOREIGN KEY (SenderId) REFERENCES Users(UserId),
    FOREIGN KEY (TargetRoomId) REFERENCES ChatRooms(RoomId),
    FOREIGN KEY (TargetUserId) REFERENCES Users(UserId),
    FOREIGN KEY (ReplyToMessageId) REFERENCES Messages(MessageId)
);

-- 房间成员表
CREATE TABLE RoomMembers (
    RoomId TEXT,
    UserId TEXT,
    JoinedAt DATETIME DEFAULT CURRENT_TIMESTAMP,
    Role INTEGER DEFAULT 0,
    PRIMARY KEY (RoomId, UserId),
    FOREIGN KEY (RoomId) REFERENCES ChatRooms(RoomId),
    FOREIGN KEY (UserId) REFERENCES Users(UserId)
);

-- 用户会话表
CREATE TABLE UserSessions (
    SessionId TEXT PRIMARY KEY,
    UserId TEXT NOT NULL,
    IpAddress TEXT,
    UserAgent TEXT,
    CreatedAt DATETIME DEFAULT CURRENT_TIMESTAMP,
    LastActivity DATETIME DEFAULT CURRENT_TIMESTAMP,
    IsActive BOOLEAN DEFAULT 1,
    FOREIGN KEY (UserId) REFERENCES Users(UserId)
);

-- 索引
CREATE INDEX idx_messages_room_timestamp ON Messages(TargetRoomId, Timestamp);
CREATE INDEX idx_messages_private_timestamp ON Messages(TargetUserId, SenderId, Timestamp);
CREATE INDEX idx_users_username ON Users(Username);
CREATE INDEX idx_rooms_name ON ChatRooms(RoomName);
CREATE INDEX idx_room_members_user ON RoomMembers(UserId);
```

### 2. 数据迁移策略

```csharp
public interface IDataMigration
{
    Task<bool> ExportToFileAsync(string filePath);
    Task<bool> ImportFromFileAsync(string filePath);
    Task<bool> MigrateToSqliteAsync(string connectionString);
    Task<bool> MigrateFromSqliteAsync(string connectionString);
}

public class DataMigrationService : IDataMigration
{
    private readonly IDataStore _dataStore;
    private readonly ILogger<DataMigrationService> _logger;
    
    public async Task<bool> ExportToFileAsync(string filePath)
    {
        var exportData = new
        {
            Users = await _dataStore.GetOnlineUsersAsync(),
            Rooms = await _dataStore.GetAllRoomsAsync(),
            Messages = await GetRecentMessagesAsync(),
            ExportedAt = DateTime.UtcNow
        };
        
        var json = JsonSerializer.Serialize(exportData, new JsonSerializerOptions
        {
            WriteIndented = true
        });
        
        await File.WriteAllTextAsync(filePath, json);
        return true;
    }
}
```

## 性能优化策略

### 1. 内存优化
- 使用对象池减少GC压力
- 定期清理过期数据
- 限制缓存大小
- 使用弱引用存储临时数据

### 2. 查询优化
- 使用索引加速查找
- 缓存热点数据
- 异步查询避免阻塞
- 批量操作减少锁竞争

### 3. 并发优化
- 使用ConcurrentDictionary等线程安全集合
- 读写分离策略
- 无锁编程模式
- 分片存储减少锁粒度

## 监控和统计

### 1. 数据统计模型

```csharp
public class ServerStatistics
{
    public int TotalUsers { get; set; }
    public int OnlineUsers { get; set; }
    public int TotalRooms { get; set; }
    public int ActiveRooms { get; set; }
    public long TotalMessages { get; set; }
    public long MessagesPerMinute { get; set; }
    public TimeSpan Uptime { get; set; }
    public long MemoryUsage { get; set; }
    public DateTime LastUpdated { get; set; }
}

public class RoomStatistics
{
    public string RoomId { get; set; }
    public string RoomName { get; set; }
    public int MemberCount { get; set; }
    public int MessageCount { get; set; }
    public DateTime LastActivity { get; set; }
    public double ActivityScore { get; set; }
}
```

### 2. 性能监控

```csharp
public class PerformanceMonitor
{
    private readonly Timer _statsTimer;
    private readonly IDataStore _dataStore;
    
    public void StartMonitoring()
    {
        _statsTimer = new Timer(CollectStatistics, null, 
            TimeSpan.Zero, TimeSpan.FromMinutes(1));
    }
    
    private async void CollectStatistics(object state)
    {
        var stats = new ServerStatistics
        {
            TotalUsers = await _dataStore.GetUserCountAsync(),
            OnlineUsers = await _dataStore.GetOnlineUserCountAsync(),
            TotalRooms = await _dataStore.GetRoomCountAsync(),
            MemoryUsage = GC.GetTotalMemory(false),
            LastUpdated = DateTime.UtcNow
        };
        
        // 记录统计信息
        await RecordStatisticsAsync(stats);
    }
}
```

---

*本数据设计文档将随着项目需求变化持续更新*