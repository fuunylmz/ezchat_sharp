# EzChat Sharp - 部署运维文档

## 概述

EzChat Sharp 是一个基于 .NET 9.0 的聊天服务器应用程序，本文档详细说明了在不同环境下的部署、配置、监控和维护方案。

## 环境要求

### 系统要求
- **操作系统**: Windows 10/11, Windows Server 2019/2022, Linux (Ubuntu 20.04+, CentOS 8+), macOS 12+
- **运行时**: .NET 9.0 Runtime
- **内存**: 最小 512MB，推荐 2GB+
- **存储**: 最小 100MB，推荐 1GB+
- **网络**: TCP 端口访问权限

### 软件依赖
- .NET 9.0 SDK (开发环境)
- .NET 9.0 Runtime (生产环境)
- Git (版本控制)
- 可选：Docker (容器化部署)
- 可选：Nginx (反向代理)

## 开发环境部署

### 1. 环境搭建

#### Windows 环境
```powershell
# 安装 .NET 9.0 SDK
winget install Microsoft.DotNet.SDK.9

# 验证安装
dotnet --version

# 克隆项目
git clone https://github.com/your-repo/ezchat-sharp.git
cd ezchat-sharp

# 还原依赖
dotnet restore

# 构建项目
dotnet build
```

#### Linux 环境
```bash
# Ubuntu/Debian
wget https://packages.microsoft.com/config/ubuntu/22.04/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
sudo dpkg -i packages-microsoft-prod.deb
sudo apt-get update
sudo apt-get install -y dotnet-sdk-9.0

# CentOS/RHEL
sudo rpm -Uvh https://packages.microsoft.com/config/centos/8/packages-microsoft-prod.rpm
sudo dnf install dotnet-sdk-9.0

# 验证安装
dotnet --version

# 克隆和构建
git clone https://github.com/your-repo/ezchat-sharp.git
cd ezchat-sharp
dotnet restore
dotnet build
```

### 2. 开发环境配置

#### appsettings.Development.json
```json
{
  "Server": {
    "Port": 8080,
    "MaxConnections": 50,
    "MessageBufferSize": 1024,
    "HeartbeatInterval": 30,
    "ConnectionTimeout": 300
  },
  "Logging": {
    "LogLevel": {
      "Default": "Debug",
      "EzChatSharp": "Trace",
      "Microsoft": "Warning",
      "System": "Warning"
    },
    "Console": {
      "IncludeScopes": true
    },
    "File": {
      "Path": "logs/ezchat-{Date}.log",
      "RollingInterval": "Day",
      "RetainedFileCountLimit": 7
    }
  },
  "Features": {
    "EnableDetailedErrors": true,
    "EnableMetrics": true,
    "EnableSwagger": true
  }
}
```

### 3. 启动开发环境

```bash
# 启动服务器（终端1）
dotnet run --project src/EzChatSharp.Server

# 启动客户端（终端2）
dotnet run --project src/EzChatSharp.Client

# 或使用 watch 模式（自动重启）
dotnet watch run --project src/EzChatSharp.Server
```

## 测试环境部署

### 1. 测试环境配置

#### appsettings.Testing.json
```json
{
  "Server": {
    "Port": 8081,
    "MaxConnections": 100,
    "MessageBufferSize": 2048,
    "HeartbeatInterval": 30,
    "ConnectionTimeout": 300
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "EzChatSharp": "Debug",
      "Microsoft": "Warning"
    },
    "File": {
      "Path": "logs/test/ezchat-{Date}.log",
      "RollingInterval": "Day",
      "RetainedFileCountLimit": 30
    }
  },
  "Features": {
    "EnableDetailedErrors": true,
    "EnableMetrics": true,
    "EnableSwagger": false
  },
  "Testing": {
    "AutoCreateTestUsers": true,
    "TestDataSeed": 12345,
    "SimulateNetworkDelay": false
  }
}
```

### 2. 自动化部署脚本

#### deploy-test.sh
```bash
#!/bin/bash

# 测试环境部署脚本
set -e

echo "开始部署测试环境..."

# 拉取最新代码
git pull origin develop

# 停止现有服务
echo "停止现有服务..."
pkill -f "EzChatSharp.Server" || true

# 构建项目
echo "构建项目..."
dotnet clean
dotnet restore
dotnet build -c Release

# 运行测试
echo "运行测试..."
dotnet test --no-build -c Release

# 发布应用
echo "发布应用..."
dotnet publish src/EzChatSharp.Server -c Release -o ./publish/server
dotnet publish src/EzChatSharp.Client -c Release -o ./publish/client

# 备份当前版本
echo "备份当前版本..."
if [ -d "/opt/ezchat/current" ]; then
    sudo mv /opt/ezchat/current /opt/ezchat/backup-$(date +%Y%m%d-%H%M%S)
fi

# 部署新版本
echo "部署新版本..."
sudo mkdir -p /opt/ezchat/current
sudo cp -r ./publish/* /opt/ezchat/current/
sudo chown -R ezchat:ezchat /opt/ezchat/current
sudo chmod +x /opt/ezchat/current/server/EzChatSharp.Server

# 启动服务
echo "启动服务..."
sudo systemctl start ezchat-server
sudo systemctl enable ezchat-server

# 验证部署
echo "验证部署..."
sleep 5
if curl -f http://localhost:8081/health; then
    echo "部署成功！"
else
    echo "部署失败，回滚到备份版本"
    sudo systemctl stop ezchat-server
    sudo rm -rf /opt/ezchat/current
    sudo mv /opt/ezchat/backup-* /opt/ezchat/current
    sudo systemctl start ezchat-server
    exit 1
fi

echo "测试环境部署完成"
```

## 生产环境部署

### 1. 生产环境配置

#### appsettings.Production.json
```json
{
  "Server": {
    "Port": 8080,
    "MaxConnections": 1000,
    "MessageBufferSize": 4096,
    "HeartbeatInterval": 30,
    "ConnectionTimeout": 300,
    "EnableSsl": false,
    "CertificatePath": "",
    "CertificatePassword": ""
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "EzChatSharp": "Information",
      "Microsoft": "Warning",
      "System": "Warning"
    },
    "File": {
      "Path": "/var/log/ezchat/ezchat-{Date}.log",
      "RollingInterval": "Day",
      "RetainedFileCountLimit": 90,
      "FileSizeLimitBytes": 104857600
    },
    "EventLog": {
      "SourceName": "EzChatSharp",
      "LogName": "Application"
    }
  },
  "Performance": {
    "EnableGCOptimization": true,
    "MaxMemoryUsageMB": 2048,
    "ThreadPoolMinThreads": 50,
    "ThreadPoolMaxThreads": 200
  },
  "Security": {
    "EnableRateLimiting": true,
    "MaxRequestsPerMinute": 60,
    "EnableIpWhitelist": false,
    "AllowedIpRanges": []
  },
  "Features": {
    "EnableDetailedErrors": false,
    "EnableMetrics": true,
    "EnableSwagger": false,
    "EnableHealthChecks": true
  }
}
```

### 2. Systemd 服务配置

#### /etc/systemd/system/ezchat-server.service
```ini
[Unit]
Description=EzChat Sharp Server
After=network.target
Wants=network.target

[Service]
Type=notify
User=ezchat
Group=ezchat
WorkingDirectory=/opt/ezchat/current/server
ExecStart=/opt/ezchat/current/server/EzChatSharp.Server
Restart=always
RestartSec=10
KillSignal=SIGINT
Environment=ASPNETCORE_ENVIRONMENT=Production
Environment=DOTNET_PRINT_TELEMETRY_MESSAGE=false

# 资源限制
LimitNOFILE=65536
LimitNPROC=4096

# 安全设置
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/var/log/ezchat /opt/ezchat/current/data

[Install]
WantedBy=multi-user.target
```

### 3. 用户和权限设置

```bash
# 创建专用用户
sudo useradd -r -s /bin/false ezchat

# 创建目录结构
sudo mkdir -p /opt/ezchat/{current,backup,data}
sudo mkdir -p /var/log/ezchat
sudo mkdir -p /etc/ezchat

# 设置权限
sudo chown -R ezchat:ezchat /opt/ezchat
sudo chown -R ezchat:ezchat /var/log/ezchat
sudo chmod 755 /opt/ezchat
sudo chmod 750 /var/log/ezchat

# 配置日志轮转
sudo tee /etc/logrotate.d/ezchat << EOF
/var/log/ezchat/*.log {
    daily
    rotate 90
    compress
    delaycompress
    missingok
    notifempty
    create 644 ezchat ezchat
    postrotate
        systemctl reload ezchat-server
    endscript
}
EOF
```

### 4. 生产部署脚本

#### deploy-prod.sh
```bash
#!/bin/bash

# 生产环境部署脚本
set -e

VERSION=${1:-$(date +%Y%m%d-%H%M%S)}
BACKUP_DIR="/opt/ezchat/backup-$VERSION"
CURRENT_DIR="/opt/ezchat/current"
TEMP_DIR="/tmp/ezchat-deploy-$VERSION"

echo "开始生产环境部署 - 版本: $VERSION"

# 预检查
echo "执行预检查..."
if ! systemctl is-active --quiet ezchat-server; then
    echo "警告: 服务当前未运行"
fi

# 健康检查
if ! curl -f http://localhost:8080/health > /dev/null 2>&1; then
    echo "警告: 健康检查失败"
fi

# 创建临时目录
mkdir -p $TEMP_DIR
cd $TEMP_DIR

# 拉取代码
echo "拉取最新代码..."
git clone --branch main --depth 1 https://github.com/your-repo/ezchat-sharp.git .

# 构建项目
echo "构建项目..."
dotnet restore
dotnet build -c Release

# 运行测试
echo "运行关键测试..."
dotnet test tests/EzChatSharp.UnitTests -c Release --filter Category=Critical

# 发布应用
echo "发布应用..."
dotnet publish src/EzChatSharp.Server -c Release -o ./publish/server --self-contained false
dotnet publish src/EzChatSharp.Client -c Release -o ./publish/client --self-contained false

# 备份当前版本
echo "备份当前版本..."
if [ -d "$CURRENT_DIR" ]; then
    sudo cp -r $CURRENT_DIR $BACKUP_DIR
    echo "备份完成: $BACKUP_DIR"
fi

# 停止服务
echo "停止服务..."
sudo systemctl stop ezchat-server

# 部署新版本
echo "部署新版本..."
sudo rm -rf $CURRENT_DIR
sudo mkdir -p $CURRENT_DIR
sudo cp -r ./publish/* $CURRENT_DIR/
sudo chown -R ezchat:ezchat $CURRENT_DIR
sudo chmod +x $CURRENT_DIR/server/EzChatSharp.Server

# 启动服务
echo "启动服务..."
sudo systemctl start ezchat-server

# 等待服务启动
echo "等待服务启动..."
sleep 10

# 验证部署
echo "验证部署..."
for i in {1..30}; do
    if curl -f http://localhost:8080/health > /dev/null 2>&1; then
        echo "部署成功验证通过！"
        break
    fi
    if [ $i -eq 30 ]; then
        echo "部署验证失败，开始回滚..."
        sudo systemctl stop ezchat-server
        sudo rm -rf $CURRENT_DIR
        sudo mv $BACKUP_DIR $CURRENT_DIR
        sudo systemctl start ezchat-server
        echo "回滚完成"
        exit 1
    fi
    sleep 2
done

# 清理
echo "清理临时文件..."
rm -rf $TEMP_DIR

# 清理旧备份（保留最近5个）
echo "清理旧备份..."
ls -t /opt/ezchat/backup-* | tail -n +6 | xargs -r sudo rm -rf

echo "生产环境部署完成 - 版本: $VERSION"
```

## 容器化部署

### 1. Dockerfile

#### Dockerfile.server
```dockerfile
# 构建阶段
FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build
WORKDIR /src

# 复制项目文件
COPY ["src/EzChatSharp.Server/EzChatSharp.Server.csproj", "src/EzChatSharp.Server/"]
COPY ["src/EzChatSharp.Shared/EzChatSharp.Shared.csproj", "src/EzChatSharp.Shared/"]
RUN dotnet restore "src/EzChatSharp.Server/EzChatSharp.Server.csproj"

# 复制源代码
COPY . .
WORKDIR "/src/src/EzChatSharp.Server"
RUN dotnet build "EzChatSharp.Server.csproj" -c Release -o /app/build

# 发布阶段
FROM build AS publish
RUN dotnet publish "EzChatSharp.Server.csproj" -c Release -o /app/publish

# 运行时阶段
FROM mcr.microsoft.com/dotnet/aspnet:9.0 AS final
WORKDIR /app

# 创建非root用户
RUN groupadd -r ezchat && useradd -r -g ezchat ezchat

# 复制应用文件
COPY --from=publish /app/publish .

# 创建日志目录
RUN mkdir -p /app/logs && chown -R ezchat:ezchat /app

# 切换到非root用户
USER ezchat

# 暴露端口
EXPOSE 8080

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8080/health || exit 1

# 启动应用
ENTRYPOINT ["dotnet", "EzChatSharp.Server.dll"]
```

### 2. Docker Compose

#### docker-compose.yml
```yaml
version: '3.8'

services:
  ezchat-server:
    build:
      context: .
      dockerfile: Dockerfile.server
    container_name: ezchat-server
    ports:
      - "8080:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
    volumes:
      - ./logs:/app/logs
      - ./data:/app/data
      - ./config/appsettings.Production.json:/app/appsettings.Production.json:ro
    restart: unless-stopped
    networks:
      - ezchat-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  nginx:
    image: nginx:alpine
    container_name: ezchat-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - ezchat-server
    restart: unless-stopped
    networks:
      - ezchat-network

networks:
  ezchat-network:
    driver: bridge

volumes:
  ezchat-logs:
  ezchat-data:
```

### 3. Nginx 配置

#### nginx/nginx.conf
```nginx
events {
    worker_connections 1024;
}

http {
    upstream ezchat_backend {
        server ezchat-server:8080;
    }
    
    # 限流配置
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
    
    server {
        listen 80;
        server_name your-domain.com;
        
        # 重定向到HTTPS
        return 301 https://$server_name$request_uri;
    }
    
    server {
        listen 443 ssl http2;
        server_name your-domain.com;
        
        # SSL配置
        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
        
        # 安全头
        add_header X-Frame-Options DENY;
        add_header X-Content-Type-Options nosniff;
        add_header X-XSS-Protection "1; mode=block";
        
        # 限流
        limit_req zone=api burst=20 nodelay;
        
        location / {
            proxy_pass http://ezchat_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # WebSocket支持
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            # 超时设置
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }
        
        location /health {
            proxy_pass http://ezchat_backend/health;
            access_log off;
        }
    }
}
```

## 监控和告警

### 1. 健康检查端点

```csharp
// HealthCheckExtensions.cs
public static class HealthCheckExtensions
{
    public static IServiceCollection AddEzChatHealthChecks(this IServiceCollection services)
    {
        services.AddHealthChecks()
            .AddCheck<ServerHealthCheck>("server")
            .AddCheck<MemoryHealthCheck>("memory")
            .AddCheck<ConnectionHealthCheck>("connections");
            
        return services;
    }
}

// ServerHealthCheck.cs
public class ServerHealthCheck : IHealthCheck
{
    private readonly ChatServer _chatServer;
    
    public async Task<HealthCheckResult> CheckHealthAsync(
        HealthCheckContext context, 
        CancellationToken cancellationToken = default)
    {
        try
        {
            if (!_chatServer.IsRunning)
            {
                return HealthCheckResult.Unhealthy("Server is not running");
            }
            
            var stats = await _chatServer.GetStatisticsAsync();
            
            var data = new Dictionary<string, object>
            {
                ["uptime"] = stats.Uptime,
                ["connections"] = stats.ActiveConnections,
                ["memory_mb"] = stats.MemoryUsageMB
            };
            
            return HealthCheckResult.Healthy("Server is running", data);
        }
        catch (Exception ex)
        {
            return HealthCheckResult.Unhealthy("Health check failed", ex);
        }
    }
}
```

### 2. 监控脚本

#### monitor.sh
```bash
#!/bin/bash

# 监控脚本
LOG_FILE="/var/log/ezchat/monitor.log"
HEALTH_URL="http://localhost:8080/health"
ALERT_EMAIL="admin@yourdomain.com"

log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> $LOG_FILE
}

check_health() {
    if curl -f -s $HEALTH_URL > /dev/null; then
        return 0
    else
        return 1
    fi
}

check_memory() {
    local memory_usage=$(ps -o pid,ppid,cmd,%mem,%cpu --sort=-%mem -C EzChatSharp.Server | awk 'NR==2{print $4}')
    if (( $(echo "$memory_usage > 80" | bc -l) )); then
        return 1
    fi
    return 0
}

check_connections() {
    local connections=$(netstat -an | grep :8080 | grep ESTABLISHED | wc -l)
    if [ $connections -gt 900 ]; then
        return 1
    fi
    return 0
}

send_alert() {
    local message="$1"
    echo "$message" | mail -s "EzChat Alert" $ALERT_EMAIL
    log "ALERT: $message"
}

# 主监控循环
while true; do
    if ! check_health; then
        send_alert "Health check failed - service may be down"
        log "Health check failed"
    fi
    
    if ! check_memory; then
        send_alert "High memory usage detected"
        log "High memory usage"
    fi
    
    if ! check_connections; then
        send_alert "High connection count detected"
        log "High connection count"
    fi
    
    sleep 60
done
```

### 3. Prometheus 监控

#### prometheus.yml
```yaml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'ezchat-server'
    static_configs:
      - targets: ['localhost:8080']
    metrics_path: '/metrics'
    scrape_interval: 10s
    
rule_files:
  - "ezchat_rules.yml"

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093
```

#### ezchat_rules.yml
```yaml
groups:
  - name: ezchat_alerts
    rules:
      - alert: EzChatServerDown
        expr: up{job="ezchat-server"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "EzChat server is down"
          description: "EzChat server has been down for more than 1 minute"
          
      - alert: HighMemoryUsage
        expr: ezchat_memory_usage_bytes / ezchat_memory_limit_bytes > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage"
          description: "Memory usage is above 80% for 5 minutes"
          
      - alert: HighConnectionCount
        expr: ezchat_active_connections > 900
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High connection count"
          description: "Active connections exceed 900 for 2 minutes"
```

## 备份和恢复

### 1. 备份策略

#### backup.sh
```bash
#!/bin/bash

# 备份脚本
BACKUP_DIR="/backup/ezchat"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="ezchat_backup_$DATE.tar.gz"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份应用程序
echo "备份应用程序..."
tar -czf $BACKUP_DIR/app_$DATE.tar.gz -C /opt/ezchat current

# 备份配置文件
echo "备份配置文件..."
tar -czf $BACKUP_DIR/config_$DATE.tar.gz -C /etc ezchat

# 备份日志文件
echo "备份日志文件..."
tar -czf $BACKUP_DIR/logs_$DATE.tar.gz -C /var/log ezchat

# 创建完整备份
echo "创建完整备份..."
tar -czf $BACKUP_DIR/$BACKUP_FILE \
    -C /opt/ezchat current \
    -C /etc ezchat \
    -C /var/log ezchat

# 清理旧备份（保留30天）
find $BACKUP_DIR -name "*.tar.gz" -mtime +30 -delete

echo "备份完成: $BACKUP_DIR/$BACKUP_FILE"
```

### 2. 恢复脚本

#### restore.sh
```bash
#!/bin/bash

# 恢复脚本
BACKUP_FILE="$1"

if [ -z "$BACKUP_FILE" ]; then
    echo "用法: $0 <backup_file>"
    exit 1
fi

if [ ! -f "$BACKUP_FILE" ]; then
    echo "备份文件不存在: $BACKUP_FILE"
    exit 1
fi

echo "开始恢复..."

# 停止服务
echo "停止服务..."
sudo systemctl stop ezchat-server

# 备份当前版本
echo "备份当前版本..."
sudo mv /opt/ezchat/current /opt/ezchat/current.backup.$(date +%Y%m%d_%H%M%S)

# 恢复文件
echo "恢复文件..."
sudo tar -xzf "$BACKUP_FILE" -C /

# 设置权限
echo "设置权限..."
sudo chown -R ezchat:ezchat /opt/ezchat/current
sudo chmod +x /opt/ezchat/current/EzChatSharp.Server

# 启动服务
echo "启动服务..."
sudo systemctl start ezchat-server

# 验证恢复
echo "验证恢复..."
sleep 5
if curl -f http://localhost:8080/health; then
    echo "恢复成功！"
else
    echo "恢复失败，请检查日志"
    exit 1
fi
```

## 性能调优

### 1. 系统级优化

#### /etc/sysctl.conf
```bash
# 网络优化
net.core.somaxconn = 65535
net.core.netdev_max_backlog = 5000
net.ipv4.tcp_max_syn_backlog = 65535
net.ipv4.tcp_fin_timeout = 30
net.ipv4.tcp_keepalive_time = 1200
net.ipv4.tcp_max_tw_buckets = 5000

# 内存优化
vm.swappiness = 10
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5

# 文件描述符限制
fs.file-max = 2097152
```

#### /etc/security/limits.conf
```bash
ezchat soft nofile 65535
ezchat hard nofile 65535
ezchat soft nproc 32768
ezchat hard nproc 32768
```

### 2. 应用级优化

#### Program.cs 优化配置
```csharp
public static void Main(string[] args)
{
    // GC 优化
    GCSettings.LatencyMode = GCLatencyMode.SustainedLowLatency;
    
    // 线程池优化
    ThreadPool.SetMinThreads(50, 50);
    ThreadPool.SetMaxThreads(200, 200);
    
    var builder = WebApplication.CreateBuilder(args);
    
    // Kestrel 优化
    builder.WebHost.ConfigureKestrel(options =>
    {
        options.Limits.MaxConcurrentConnections = 1000;
        options.Limits.MaxConcurrentUpgradedConnections = 1000;
        options.Limits.MaxRequestBodySize = 1024 * 1024; // 1MB
        options.Limits.KeepAliveTimeout = TimeSpan.FromMinutes(2);
        options.Limits.RequestHeadersTimeout = TimeSpan.FromSeconds(30);
    });
    
    var app = builder.Build();
    app.Run();
}
```

## 故障排除

### 1. 常见问题诊断

#### 诊断脚本 diagnose.sh
```bash
#!/bin/bash

echo "=== EzChat 诊断报告 ==="
echo "时间: $(date)"
echo

# 服务状态
echo "=== 服务状态 ==="
systemctl status ezchat-server
echo

# 端口监听
echo "=== 端口监听 ==="
netstat -tlnp | grep :8080
echo

# 进程信息
echo "=== 进程信息 ==="
ps aux | grep EzChatSharp
echo

# 内存使用
echo "=== 内存使用 ==="
free -h
echo

# 磁盘空间
echo "=== 磁盘空间 ==="
df -h
echo

# 最近日志
echo "=== 最近日志 ==="
tail -50 /var/log/ezchat/ezchat-$(date +%Y-%m-%d).log
echo

# 网络连接
echo "=== 网络连接 ==="
netstat -an | grep :8080 | head -20
echo

# 系统负载
echo "=== 系统负载 ==="
uptime
echo
```

### 2. 日志分析

#### 日志分析脚本 analyze-logs.sh
```bash
#!/bin/bash

LOG_FILE="/var/log/ezchat/ezchat-$(date +%Y-%m-%d).log"

echo "=== 错误统计 ==="
grep -i "error\|exception\|fail" $LOG_FILE | wc -l
echo

echo "=== 最频繁的错误 ==="
grep -i "error\|exception" $LOG_FILE | cut -d']' -f2- | sort | uniq -c | sort -nr | head -10
echo

echo "=== 连接统计 ==="
grep "Client connected" $LOG_FILE | wc -l
echo "总连接数:"
grep "Client disconnected" $LOG_FILE | wc -l
echo "总断开数:"
echo

echo "=== 性能指标 ==="
grep "Performance" $LOG_FILE | tail -10
echo
```

---

*本部署运维文档将随着项目发展持续更新和完善*